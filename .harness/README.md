## React CircleCI to Harness CI Migration Guide:

Before migrating from [CircleCI to Harness CI](https://github.com/harness-community/ci-migration-guides/tree/main/CIRCLECI_TO_HARNESS_CI), kindly go through [this](https://github.com/harness-community/ci-migration-guides/tree/main/CIRCLECI_TO_HARNESS_CI) guide.  
![](https://33333.cdn.cke-cs.com/kSW7V9NHUXugvhoQeFaf/images/8950a8c152d7b6f986dc62d9a07942d34f24d956e3e994a0.png)  
![](https://33333.cdn.cke-cs.com/kSW7V9NHUXugvhoQeFaf/images/7a07a6fe2b46eb45cc004032fdc1eb97cae1d8cea0574715.png)

### Challenge in Sharing Data between Stages:

Faced challenges, particularly with sharing data between two stages: `Yarn Build Combined` and `Yarn Test Build`. The `Yarn Build Combined` stage has a parallelism of 40 on the stage level, while the `Yarn Test Build` has a matrix of 5 and a parallelism of 20 for each run of the matrix on the stage level.Each run `yarn Build Combined` creates a workspace layer for the `/build` path and attaches it to the Yarn Test Build stage. This means that each run of the Yarn Test Build stage has the context of all 40 layers generated by the Yarn Build stage.  
What Did Not Work:

1.  Using step groups at the step level.
2.  Using caching with parallelism - this overrides the context for /build every time.
3.  Using the index as a cache key - this will change for each saved cache and restored cache based on iteration, but the source path will remain the same, thereby overriding the context of the same path in the second stage while restoring in each iteration.

What Worked:

1.  In the first stage (parallelism: 40), use "Upload Artifacts to GCS" in place of "save cache."
2.  In the second stage, write a script to download the artifacts from the GCS bucket.

### **How to achieve multiple  looping strategies on  stage level** 

*   Use Case: I need to perform the same set of tasks on a matrix of 5 and for each instance of the matrix, I need to do a parallelism of 20.
*   How CircleCI Does It: CircleCI allows using a matrix with parallelism.

```plaintext
#job (this job will run 20 parallism for each matrix input )
  yarn_test:
    docker: *docker
    environment: *environment
    parallelism: 20
    parameters:
      args:
        type: string
    steps:
      - checkout
      - *restore_node_modules
      - run: yarn test <<parameters.args>> --ci


# pass matrix parm in workflow 
workflows:
  version: 2
  build_and_test:
    jobs:
      - yarn_test:
          requires:
            - setup
          matrix:
            parameters:
              args:
                # Intentionally passing these as strings instead of creating a
                # separate parameter per CLI argument, since it's easier to
                # control/see which combinations we want to run.
                - "-r=stable --env=development"
                - "-r=stable --env=production"
                - "-r=experimental --env=development"
                - "-r=experimental --env=production"
                - "-r=www-classic --env=development --variant=false"
                - "-r=www-classic --env=production --variant=false"
                - "-r=www-classic --env=development --variant=true"
                - "-r=www-classic --env=production --variant=true"
                - "-r=www-modern --env=development --variant=false"
                - "-r=www-modern --env=production --variant=false"
                - "-r=www-modern --env=development --variant=true"
                - "-r=www-modern --env=production --variant=true"

                # TODO: Test more persistent configurations?
                - '-r=stable --env=development --persistent'
                - '-r=experimental --env=development --persistent'
```

*   How We Did It in Harness: We did the matrix at the stage level and parallelism at the step level. How to do both at the stage level?

```plaintext
        - stage:
            identifier: yarntest
            type: CI
            name: yarn test
            spec:
              cloneCodebase: true
              platform:
                os: Linux
                arch: Amd64
              runtime:
                type: Cloud
                spec: {}
              execution:
                steps:
                  - step:
                      identifier: restore_node_modules
                      type: RestoreCacheGCS
                      name: restore_node_modules
                      spec:
                        connectorRef: ronakgcpbucket
                        bucket: migration-artifact-comman
                        key: v1-node_modules-{{ arch }}-{{ .Revision }}
                        archiveFormat: Tar
                      when:
                        stageStatus: Success
                      failureStrategies: []
                  - step:
                      identifier: yarn_flow
                      type: Run
                      name: yarn test
                      spec:
                        shell: Sh
                        command: yarn test <+repeat.item> --ci
                        envVariables:
                          CIRCLE_NODE_INDEX: <+strategy.iteration>
                          CIRCLE_NODE_TOTAL: <+strategy.iterations>
                          TZ: /usr/share/zoneinfo/America/Los_Angeles
                      when:
                        stageStatus: Success
                      failureStrategies: []
                      strategy:
                        parallelism: 20
                        maxConcurrency: 20
              sharedPaths:
                - /home/ubuntu/
            strategy:
              repeat:
                items:
                  - "-r=stable --env=development"
                  - "-r=stable --env=production"
                  - "-r=experimental --env=development"
                  - "-r=experimental --env=production"
                  - "-r=www-classic --env=development --variant=false"
                  - "-r=www-classic --env=production --variant=false"
                  - "-r=www-classic --env=development --variant=true"
                  - "-r=www-classic --env=production --variant=true"
                  - "-r=www-modern --env=development --variant=false"
                  - "-r=www-modern --env=production --variant=false"
                  - "-r=www-modern --env=development --variant=true"
                  - "-r=www-modern --env=production --variant=true"
                  - "-r=stable --env=development --persistent"
                  - "-r=experimental --env=development --persistent"
                maxConcurrency: 15
            when:
              pipelineStatus: Success
```

## Wait time before moving to next stage 

Consider a  pipeline with 3 stages A B C  with the following  requirements 

*   A and  B are parallel 
*   C requires  B .
*   A takes 10 mins to complete
*   B takes 2 min
*   C takes 5 min 

What will be the total execution time of the pipeline ?

*   CircelCi : 10 mins. because C will start execution as soon as B ends . Its not dependent on A.
*   Harness CI :  12 mins .  C will wait for both A and B to be completed , ie C has to wait  8 mins  extra
